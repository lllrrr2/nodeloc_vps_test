<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NodeLoc VPS Benchmark Results</title>
    
    <!-- Bootstrap 5 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Bootstrap Icons -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css" rel="stylesheet">
    
    <style>
        :root {
            --primary-orange: #ff6b35;
            --primary-dark: #e55525;
        }

        body {
            background: url('https://s.rmimg.com/2026/01/08/aed304d968a11c1e789b227f0453dfe1.jpg') center center / cover no-repeat fixed;
            min-height: 100vh;
            padding: 20px;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        }

        /* Glass morphism effect */
        .glass-card {
            background: rgba(255, 255, 255, 0.25);
            backdrop-filter: blur(20px) saturate(180%);
            -webkit-backdrop-filter: blur(20px) saturate(180%);
            border: 1px solid rgba(255, 255, 255, 0.5);
            border-radius: 16px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
        }

        .glass-light {
            background: rgba(255, 255, 255, 0.2);
            backdrop-filter: blur(15px) saturate(180%);
            -webkit-backdrop-filter: blur(15px) saturate(180%);
        }

        /* Custom colors */
        .btn-primary {
            background-color: var(--primary-orange);
            border-color: var(--primary-orange);
        }

        .btn-primary:hover {
            background-color: var(--primary-dark);
            border-color: var(--primary-dark);
        }

        .nav-tabs .nav-link.active {
            background-color: rgba(255, 255, 255, 0.9);
            border-color: var(--primary-orange);
            color: #000;
            font-weight: 600;
            text-shadow: none;
        }

        .nav-tabs .nav-link {
            border: none;
            color: #fff;
            transition: all 0.3s;
            text-shadow: 1px 1px 3px rgba(0, 0, 0, 0.7);
            font-weight: 500;
        }

        .nav-tabs .nav-link:hover {
            color: #000;
            background: rgba(255, 255, 255, 0.6);
            text-shadow: none;
        }

        .nav-tabs {
            border-bottom: 2px solid rgba(255, 255, 255, 0.3);
            flex-wrap: nowrap;
            overflow-x: auto;
            overflow-y: hidden;
            -webkit-overflow-scrolling: touch;
            scrollbar-width: thin;
            scrollbar-color: var(--primary-orange) rgba(255, 255, 255, 0.1);
        }

        .nav-tabs::-webkit-scrollbar {
            height: 4px;
        }

        .nav-tabs::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 2px;
        }

        .nav-tabs::-webkit-scrollbar-thumb {
            background: var(--primary-orange);
            border-radius: 2px;
        }

        .nav-tabs .nav-item {
            white-space: nowrap;
        }

        .nav-tabs .nav-link {
            white-space: nowrap;
        }

        .text-primary-custom {
            color: #fff !important;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.5);
        }

        /* Enhanced text visibility */
        h1, h2, h3, h4, h5, h6 {
            color: #fff !important;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.5);
        }

        .text-white-50 {
            color: rgba(255, 255, 255, 0.95) !important;
            text-shadow: 1px 1px 3px rgba(0, 0, 0, 0.5);
        }

        .text-white {
            text-shadow: 1px 1px 3px rgba(0, 0, 0, 0.5);
        }

        /* Code block styling */
        .code-container {
            background: rgba(0, 0, 0, 0.6);
            border-radius: 8px;
            padding: 1.5rem;
            position: relative;
        }

        .code-container pre {
            margin: 0;
            color: #f8f9fa;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            line-height: 1.6;
            white-space: pre-wrap;
            word-wrap: break-word;
        }

        /* Spinner */
        .spinner-border-custom {
            color: var(--primary-orange);
        }

        /* Image preview */
        .img-thumbnail {
            background-color: rgba(255, 255, 255, 0.1);
            border: 2px solid rgba(255, 255, 255, 0.3);
        }

        /* Mobile optimizations */
        @media (max-width: 768px) {
            body {
                padding: 10px;
            }

            .container {
                padding-left: 0;
                padding-right: 0;
            }

            .glass-card {
                padding: 1rem !important;
                margin-bottom: 1rem !important;
            }

            h1 {
                font-size: 1.5rem !important;
            }

            .btn {
                padding: 0.5rem 0.75rem !important;
                font-size: 0.875rem !important;
            }

            .code-container {
                padding: 0.75rem !important;
            }

            .code-container pre {
                font-size: 12px !important;
            }

            /* Compact tabs for mobile */
            .nav-tabs .nav-link {
                padding: 0.5rem 0.75rem;
                font-size: 0.875rem;
            }

            /* Make buttons stack on very small screens */
            @media (max-width: 576px) {
                .col-lg-6 {
                    text-align: center !important;
                }

                .btn {
                    margin: 0.25rem !important;
                }
            }
        }
    </style>
</head>
<body>
    <div class="container py-4">
        <!-- Header -->
        <div class="glass-card p-4 mb-4">
            <div class="row align-items-center">
                <div class="col-lg-6 mb-3 mb-lg-0">
                    <h1 class="text-primary-custom mb-2">
                        <i class="bi bi-speedometer2"></i> NodeLoc VPS Benchmark
                    </h1>
                    <p class="text-white-50 mb-0">Comprehensive server performance testing report</p>
                </div>
                <div class="col-lg-6 text-lg-end">
                    <button class="btn btn-primary me-2 mb-2" id="copyAllBtn">
                        <i class="bi bi-clipboard"></i> Copy All
                    </button>
                    <button class="btn btn-success me-2 mb-2" id="downloadBtn">
                        <i class="bi bi-download"></i> Download
                    </button>
                    <a class="btn btn-outline-light mb-2" href="https://www.nodeloc.com" target="_blank">
                        <i class="bi bi-house"></i> NodeLoc
                    </a>
                </div>
            </div>
        </div>

        <!-- Loading -->
        <div class="glass-card p-5 text-center" id="loading">
            <div class="spinner-border spinner-border-custom mb-3" role="status" style="width: 3rem; height: 3rem;">
                <span class="visually-hidden">Loading...</span>
            </div>
            <p class="text-white mb-0">Loading benchmark results...</p>
        </div>

        <!-- Error -->
        <div class="alert alert-warning glass-light d-none" id="error" role="alert">
            <h4 class="alert-heading"><i class="bi bi-exclamation-triangle"></i> Error</h4>
            <p id="errorMsg" class="mb-0"></p>
        </div>

        <!-- Image Preview -->
        <div class="glass-card p-4 mb-4 text-center d-none" id="imagePreview">
            <h3 class="text-white mb-4"><i class="bi bi-graph-up"></i> Visual Report</h3>
            <img id="previewImg" alt="Benchmark Report" class="img-fluid img-thumbnail">
        </div>

        <!-- Tabs -->
        <div class="glass-card p-4 d-none" id="tabsContainer">
            <ul class="nav nav-tabs mb-4" id="tabsNav" role="tablist"></ul>
            <div class="tab-content" id="tabsContent"></div>
        </div>
    </div>

    <textarea id="copyTarget" class="visually-hidden"></textarea>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        const urlParams = new URLSearchParams(window.location.search);
        const urlPath = window.location.pathname;
        
        console.log('URL params:', urlParams.toString());
        console.log('URL path:', urlPath);
        
        // Get file parameter from URL (supports both 'file' and 'filename')
        // Priority: URL parameter > path extraction
        let filePath = urlParams.get('file') || urlParams.get('filename');
        
        console.log('File path from param:', filePath);
        
        // If no parameter, try to extract from URL path
        if (!filePath) {
            const segments = urlPath.split('/').filter(s => s);
            console.log('Path segments:', segments);
            
            // Handle /result/YYYY/MM/filename.txt format
            if (segments.length >= 4 && segments[0] === 'result') {
                const year = segments[1];
                const month = segments[2];
                const file = segments[3];
                filePath = `${year}/${month}/${file}`;
                console.log('Extracted file path from /result/:', filePath);
            }
            // Handle /bench.html in path (rewrite already done)
            else if (segments.includes('bench.html')) {
                // This means rewrite failed or direct access
                console.log('Direct bench.html access without file parameter');
            }
            // Handle /YYYY/MM/filename.txt format (fallback)
            else if (segments.length >= 3) {
                const year = segments[segments.length - 3];
                const month = segments[segments.length - 2];
                const file = segments[segments.length - 1];
                filePath = `${year}/${month}/${file}`;
                console.log('Extracted file path:', filePath);
            }
        }
        
        console.log('Final file path:', filePath);
        
        let fileContent = '';
        let tabs = [];

        // Get file path
        function getFilePath() {
            return filePath;
        }

        // Load file
        async function loadFile() {
            const filePath = getFilePath();
            
            if (!filePath) {
                showError('No file specified. Please provide a file parameter in the URL.');
                return;
            }
            
            console.log('Loading file:', filePath);
            
            try {
                const response = await fetch(filePath);
                console.log('Response status:', response.status);
                
                if (!response.ok) {
                    throw new Error(`Failed to load file: ${response.status} ${response.statusText}`);
                }
                
                fileContent = await response.text();
                console.log('File loaded, length:', fileContent.length);
                
                parseContent();
                renderTabs();
                loadImage();
                hideLoading();
            } catch (error) {
                console.error('Load error:', error);
                showError(`Error loading file: ${error.message}. File path: ${filePath}`);
            }
        }

        // Parse content
        function parseContent() {
            const tabPattern = /\[tab="([^"]+)"\]([\s\S]*?)\[\/tab\]/gi;
            let match;
            
            while ((match = tabPattern.exec(fileContent)) !== null) {
                tabs.push({
                    name: match[1],
                    content: cleanContent(match[2])
                });
            }

            if (tabs.length === 0) {
                tabs.push({ name: 'Results', content: fileContent });
            }
        }

        // Clean content
        function cleanContent(text) {
            return text.replace(/```/g, '').trim();
        }

        // Render tabs
        function renderTabs() {
            const nav = document.getElementById('tabsNav');
            const content = document.getElementById('tabsContent');
            
            tabs.forEach((tab, i) => {
                const tabId = `tab-${i}`;
                
                // Tab button (Bootstrap style)
                const li = document.createElement('li');
                li.className = 'nav-item';
                li.innerHTML = `
                    <button class="nav-link ${i === 0 ? 'active' : ''}" 
                            id="${tabId}-tab" 
                            data-bs-toggle="tab" 
                            data-bs-target="#${tabId}" 
                            type="button" 
                            role="tab">
                        ${escapeHtml(tab.name)}
                    </button>
                `;
                nav.appendChild(li);
                
                // Tab content pane (Bootstrap style)
                const pane = document.createElement('div');
                pane.className = `tab-pane fade ${i === 0 ? 'show active' : ''}`;
                pane.id = tabId;
                pane.role = 'tabpanel';
                pane.innerHTML = `
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h5 class="text-white mb-0">${escapeHtml(tab.name)}</h5>
                        <button class="btn btn-sm btn-primary" onclick="copyTab(${i})">
                            <i class="bi bi-clipboard"></i> Copy
                        </button>
                    </div>
                    <div class="code-container">
                        <pre>${escapeHtml(tab.content)}</pre>
                    </div>
                `;
                content.appendChild(pane);
            });

            document.getElementById('tabsContainer').classList.remove('d-none');
        }

        // Switch tab
        function switchTab(index) {
            document.querySelectorAll('.tab-btn').forEach((btn, i) => {
                btn.classList.toggle('active', i === index);
            });
            document.querySelectorAll('.tab-content').forEach((content, i) => {
                content.classList.toggle('active', i === index);
            });
        }

        // Copy tab
        window.copyTab = function(index) {
            copyText(tabs[index].content);
            const btn = document.querySelectorAll('.btn-primary')[index + 3]; // Skip header buttons
            if (btn) {
                const orig = btn.innerHTML;
                btn.innerHTML = '<i class="bi bi-check2"></i> Copied!';
                setTimeout(() => btn.innerHTML = orig, 2000);
            }
        };

        // Copy all
        document.getElementById('copyAllBtn').addEventListener('click', () => {
            copyText(fileContent);
            const btn = document.getElementById('copyAllBtn');
            const orig = btn.innerHTML;
            btn.innerHTML = '<i class="bi bi-check2"></i> Copied!';
            setTimeout(() => btn.innerHTML = orig, 2000);
        });

        // Download
        document.getElementById('downloadBtn').addEventListener('click', () => {
            const blob = new Blob([fileContent], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'benchmark-results.txt';
            a.click();
            URL.revokeObjectURL(url);
        });

        // Copy text
        function copyText(text) {
            const el = document.getElementById('copyTarget');
            el.value = text;
            el.select();
            document.execCommand('copy');
        }

        // Escape HTML
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Load image
        function loadImage() {
            if (!filePath) return;
            
            // Extract year, month, and filename from filePath
            const parts = filePath.split('/');
            if (parts.length < 3) return;
            
            const year = parts[0];
            const month = parts[1];
            const fileName = parts[2];
            const imgUrl = `image.php?file=${encodeURIComponent(fileName)}&year=${year}&month=${month}`;
            
            const img = document.getElementById('previewImg');
            img.onload = () => document.getElementById('imagePreview').classList.remove('d-none');
            img.onerror = () => {}; // Silently fail if image doesn't exist
            img.src = imgUrl;
        }

        // Show error
        function showError(msg) {
            document.getElementById('loading').classList.add('d-none');
            document.getElementById('error').classList.remove('d-none');
            document.getElementById('errorMsg').textContent = msg;
        }

        // Hide loading
        function hideLoading() {
            document.getElementById('loading').classList.add('d-none');
        }

        // Initialize
        loadFile();
    </script>
</body>
</html>