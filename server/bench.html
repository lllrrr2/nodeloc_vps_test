<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NodeLoc VPS Benchmark Results</title>
    
    <!-- Bootstrap 5 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Bootstrap Icons -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css" rel="stylesheet">
    
    <style>
        :root {
            --primary-orange: #ff6b35;
            --primary-dark: #e55525;
        }

        body {
            background: url('https://s.rmimg.com/2026/01/08/aed304d968a11c1e789b227f0453dfe1.jpg') center center / cover no-repeat fixed;
            min-height: 100vh;
            padding: 20px;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        }

        /* Glass morphism effect */
        .glass-card {
            background: rgba(255, 255, 255, 0.25);
            backdrop-filter: blur(20px) saturate(180%);
            -webkit-backdrop-filter: blur(20px) saturate(180%);
            border: 1px solid rgba(255, 255, 255, 0.5);
            border-radius: 16px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
        }

        .glass-light {
            background: rgba(255, 255, 255, 0.2);
            backdrop-filter: blur(15px) saturate(180%);
            -webkit-backdrop-filter: blur(15px) saturate(180%);
        }

        /* Custom colors */
        .btn-primary {
            background-color: var(--primary-orange);
            border-color: var(--primary-orange);
        }

        .btn-primary:hover {
            background-color: var(--primary-dark);
            border-color: var(--primary-dark);
        }

        .nav-tabs .nav-link.active {
            background-color: rgba(255, 255, 255, 0.9);
            border-color: var(--primary-orange);
            color: #000;
            font-weight: 600;
            text-shadow: none;
        }

        .nav-tabs .nav-link {
            border: none;
            color: #fff;
            transition: all 0.3s;
            text-shadow: 1px 1px 3px rgba(0, 0, 0, 0.7);
            font-weight: 500;
        }

        .nav-tabs .nav-link:hover {
            color: #000;
            background: rgba(255, 255, 255, 0.6);
            text-shadow: none;
        }

        .nav-tabs {
            border-bottom: 2px solid rgba(255, 255, 255, 0.3);
            flex-wrap: nowrap;
            overflow-x: auto;
            overflow-y: hidden;
            -webkit-overflow-scrolling: touch;
            scrollbar-width: thin;
            scrollbar-color: var(--primary-orange) rgba(255, 255, 255, 0.1);
        }

        .nav-tabs::-webkit-scrollbar {
            height: 4px;
        }

        .nav-tabs::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 2px;
        }

        .nav-tabs::-webkit-scrollbar-thumb {
            background: var(--primary-orange);
            border-radius: 2px;
        }

        .nav-tabs .nav-item {
            white-space: nowrap;
        }

        .nav-tabs .nav-link {
            white-space: nowrap;
        }

        .text-primary-custom {
            color: #fff !important;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.5);
        }

        /* Enhanced text visibility */
        h1, h2, h3, h4, h5, h6 {
            color: #fff !important;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.5);
        }

        .text-white-50 {
            color: rgba(255, 255, 255, 0.95) !important;
            text-shadow: 1px 1px 3px rgba(0, 0, 0, 0.5);
        }

        .text-white {
            text-shadow: 1px 1px 3px rgba(0, 0, 0, 0.5);
        }

        /* Code block styling */
        .code-container {
            background: rgba(0, 0, 0, 0.6);
            border-radius: 8px;
            padding: 1.5rem;
            position: relative;
        }

        .code-container pre {
            margin: 0;
            color: #f8f9fa;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            line-height: 1.6;
            white-space: pre-wrap;
            word-wrap: break-word;
        }

        /* Spinner */
        .spinner-border-custom {
            color: var(--primary-orange);
        }

        /* Image preview */
        .img-thumbnail {
            background-color: rgba(255, 255, 255, 0.1);
            border: 2px solid rgba(255, 255, 255, 0.3);
        }

        /* Mobile optimizations */
        @media (max-width: 768px) {
            body {
                padding: 10px;
            }

            .container {
                padding-left: 0;
                padding-right: 0;
            }

            .glass-card {
                padding: 1rem !important;
                margin-bottom: 1rem !important;
            }

            h1 {
                font-size: 1.5rem !important;
            }

            .btn {
                padding: 0.5rem 0.75rem !important;
                font-size: 0.875rem !important;
            }

            .code-container {
                padding: 0.75rem !important;
            }

            .code-container pre {
                font-size: 12px !important;
            }

            /* Compact tabs for mobile */
            .nav-tabs .nav-link {
                padding: 0.5rem 0.75rem;
                font-size: 0.875rem;
            }

            /* Make buttons stack on very small screens */
            @media (max-width: 576px) {
                .col-lg-6 {
                    text-align: center !important;
                }

                .btn {
                    margin: 0.25rem !important;
                }
            }
        }
    </style>
</head>
<body>
    <div class="container py-4">
        <!-- Header -->
        <div class="glass-card p-4 mb-4">
            <div class="row align-items-center">
                <div class="col-lg-6 mb-3 mb-lg-0">
                    <h1 class="text-primary-custom mb-2">
                        <i class="bi bi-speedometer2"></i> VPS Benchmark
                    </h1>
                    <p class="text-white-50 mb-0">Comprehensive server performance testing report</p>
                </div>
                <div class="col-lg-6 text-lg-end">
                    <div class="d-flex flex-wrap justify-content-lg-end justify-content-start gap-2">
                        <button class="btn btn-light" id="copyAllBtn">
                            <i class="bi bi-clipboard"></i> Copy All
                        </button>
                        <button class="btn btn-info" id="generateImageBtn">
                            <i class="bi bi-image"></i> Generate Image
                        </button>
                        <button class="btn btn-success" id="downloadBtn">
                            <i class="bi bi-download"></i> Download
                        </button>
                        <a class="btn btn-outline-light" href="https://www.nodeloc.com" target="_blank">
                            <i class="bi bi-house"></i> NodeLoc
                        </a>
                    </div>
                </div>
            </div>
        </div>

        <!-- Loading -->
        <div class="glass-card p-5 text-center" id="loading">
            <div class="spinner-border spinner-border-custom mb-3" role="status" style="width: 3rem; height: 3rem;">
                <span class="visually-hidden">Loading...</span>
            </div>
            <p class="text-white mb-0">Loading benchmark results...</p>
        </div>

        <!-- Error -->
        <div class="alert alert-warning glass-light d-none" id="error" role="alert">
            <h4 class="alert-heading"><i class="bi bi-exclamation-triangle"></i> Error</h4>
            <p id="errorMsg" class="mb-0"></p>
        </div>

        <!-- Image Preview -->
        <div class="glass-card p-4 mb-4 text-center d-none" id="imagePreview">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h3 class="text-white mb-0"><i class="bi bi-image"></i> Visual Report</h3>
                <div>
                    <button class="btn btn-sm btn-warning me-2" id="copyImageBtn">
                        <i class="bi bi-clipboard"></i> Copy Image
                    </button>
                    <button class="btn btn-sm btn-success me-2" id="downloadImageBtn">
                        <i class="bi bi-download"></i> Download Image
                    </button>
                    <button class="btn btn-sm btn-outline-light" id="closeImageBtn">
                        <i class="bi bi-x-lg"></i> Close
                    </button>
                </div>
            </div>
            <img id="previewImg" alt="Benchmark Report" class="img-fluid img-thumbnail">
        </div>

        <!-- Tabs -->
        <div class="glass-card p-4 d-none" id="tabsContainer">
            <ul class="nav nav-tabs mb-4" id="tabsNav" role="tablist"></ul>
            <div class="tab-content" id="tabsContent"></div>
        </div>
    </div>

    <textarea id="copyTarget" class="visually-hidden"></textarea>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        const urlParams = new URLSearchParams(window.location.search);
        const urlPath = window.location.pathname;
        
        console.log('URL params:', urlParams.toString());
        console.log('URL path:', urlPath);
        
        // Get file parameter from URL query string
        let filePath = urlParams.get('file') || urlParams.get('filename');
        
        console.log('File path from param:', filePath);
        
        // If no parameter, extract from URL path
        if (!filePath) {
            // Handle /result/YYYY/MM/filename.txt format
            if (urlPath.startsWith('/result/')) {
                // Extract everything after /result/
                filePath = urlPath.substring(8); // Remove '/result/'
                console.log('Extracted file path from /result/ URL:', filePath);
            }
            // Handle direct .txt file access
            else if (urlPath.endsWith('.txt')) {
                // Remove leading slash
                filePath = urlPath.substring(1);
                console.log('Extracted file path from direct URL:', filePath);
            }
        }
        
        console.log('Final file path:', filePath);
        
        let fileContent = '';
        let tabs = [];

        // Get file path
        function getFilePath() {
            return filePath;
        }

        // Load file
        async function loadFile() {
            const filePath = getFilePath();
            
            if (!filePath) {
                showError('No file specified. Please provide a file parameter in the URL.');
                return;
            }
            
            console.log('Attempting to load file:', filePath);
            
            try {
                // 使用 result.php 来获取文件内容（使用绝对路径）
                const fetchUrl = `/result.php?file=${encodeURIComponent(filePath)}`;
                console.log('Fetching via result.php:', fetchUrl);
                
                const response = await fetch(fetchUrl);
                console.log('Response status:', response.status);
                console.log('Response headers:', [...response.headers.entries()]);
                
                if (!response.ok) {
                    throw new Error(`Failed to load file: ${response.status} ${response.statusText}`);
                }
                
                const contentType = response.headers.get('content-type');
                console.log('Content-Type:', contentType);
                
                fileContent = await response.text();
                console.log('File loaded successfully, length:', fileContent.length);
                console.log('First 200 chars:', fileContent.substring(0, 200));
                
                parseContent();
                renderTabs();
                loadImage(); // 函数内部已禁用
                hideLoading();
            } catch (error) {
                console.error('Load error:', error);
                showError(`Error loading file: ${error.message}<br>File path: ${filePath}<br>Current URL: ${window.location.href}`);
            }
        }

        // Parse content
        function parseContent() {
            const tabPattern = /\[tab="([^"]+)"\]([\s\S]*?)\[\/tab\]/gi;
            let match;
            
            while ((match = tabPattern.exec(fileContent)) !== null) {
                tabs.push({
                    name: match[1],
                    content: cleanContent(match[2])
                });
            }

            if (tabs.length === 0) {
                tabs.push({ name: 'Results', content: fileContent });
            }
        }

        // Clean content
        function cleanContent(text) {
            return text.replace(/```/g, '').trim();
        }

        // Render tabs
        function renderTabs() {
            const nav = document.getElementById('tabsNav');
            const content = document.getElementById('tabsContent');
            
            tabs.forEach((tab, i) => {
                const tabId = `tab-${i}`;
                
                // Tab button (Bootstrap style)
                const li = document.createElement('li');
                li.className = 'nav-item';
                li.innerHTML = `
                    <button class="nav-link ${i === 0 ? 'active' : ''}" 
                            id="${tabId}-tab" 
                            data-bs-toggle="tab" 
                            data-bs-target="#${tabId}" 
                            type="button" 
                            role="tab">
                        ${escapeHtml(tab.name)}
                    </button>
                `;
                nav.appendChild(li);
                
                // Tab content pane (Bootstrap style)
                const pane = document.createElement('div');
                pane.className = `tab-pane fade ${i === 0 ? 'show active' : ''}`;
                pane.id = tabId;
                pane.role = 'tabpanel';
                pane.innerHTML = `
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h5 class="text-white mb-0">${escapeHtml(tab.name)}</h5>
                        <button class="btn btn-sm btn-primary" onclick="copyTab(${i})">
                            <i class="bi bi-clipboard"></i> Copy
                        </button>
                    </div>
                    <div class="code-container">
                        <pre>${escapeHtml(tab.content)}</pre>
                    </div>
                `;
                content.appendChild(pane);
            });

            document.getElementById('tabsContainer').classList.remove('d-none');
        }

        // Switch tab
        function switchTab(index) {
            document.querySelectorAll('.tab-btn').forEach((btn, i) => {
                btn.classList.toggle('active', i === index);
            });
            document.querySelectorAll('.tab-content').forEach((content, i) => {
                content.classList.toggle('active', i === index);
            });
        }

        // Copy tab
        window.copyTab = function(index) {
            copyText(tabs[index].content);
            const btn = document.querySelectorAll('.btn-primary')[index + 3]; // Skip header buttons
            if (btn) {
                const orig = btn.innerHTML;
                btn.innerHTML = '<i class="bi bi-check2"></i> Copied!';
                setTimeout(() => btn.innerHTML = orig, 2000);
            }
        };

        // Copy all
        document.getElementById('copyAllBtn').addEventListener('click', () => {
            copyText(fileContent);
            const btn = document.getElementById('copyAllBtn');
            const orig = btn.innerHTML;
            btn.innerHTML = '<i class="bi bi-check2"></i> Copied!';
            setTimeout(() => btn.innerHTML = orig, 2000);
        });

        // Generate Image
        document.getElementById('generateImageBtn').addEventListener('click', () => {
            const filePath = getFilePath();
            
            if (!filePath) {
                alert('No file specified');
                return;
            }
            
            // Extract year, month, and filename from filePath
            const parts = filePath.split('/');
            let year, month, fileName;
            
            if (parts.length >= 3) {
                year = parts[0];
                month = parts[1];
                fileName = parts[2];
            } else {
                // Fallback: use current date
                const now = new Date();
                year = now.getFullYear();
                month = String(now.getMonth() + 1).padStart(2, '0');
                fileName = parts[parts.length - 1];
            }
            
            // Generate image URL (SVG version)
            const imageUrl = `/image.php?file=${encodeURIComponent(fileName)}&year=${year}&month=${month}`;
            
            // Show loading state
            const btn = document.getElementById('generateImageBtn');
            const origHtml = btn.innerHTML;
            btn.innerHTML = '<span class="spinner-border spinner-border-sm me-1"></span> Generating...';
            btn.disabled = true;
            
            // Load and display image
            const img = new Image();
            img.onload = () => {
                // Display the image in preview section
                const previewImg = document.getElementById('previewImg');
                previewImg.src = imageUrl;
                document.getElementById('imagePreview').classList.remove('d-none');
                
                // Scroll to image
                document.getElementById('imagePreview').scrollIntoView({ behavior: 'smooth', block: 'nearest' });
                
                // Reset button state
                btn.innerHTML = '<i class="bi bi-check2"></i> Generated!';
                btn.disabled = false;
                setTimeout(() => {
                    btn.innerHTML = origHtml;
                }, 3000);
            };
            
            img.onerror = () => {
                alert('Failed to generate image. Please try again.');
                btn.innerHTML = origHtml;
                btn.disabled = false;
            };
            
            // Trigger image load
            img.src = imageUrl;
        });

        // Copy Image to Clipboard
        document.getElementById('copyImageBtn').addEventListener('click', async () => {
            const previewImg = document.getElementById('previewImg');
            const btn = document.getElementById('copyImageBtn');
            const origHtml = btn.innerHTML;
            
            if (!previewImg.src) {
                alert('No image to copy');
                return;
            }
            
            try {
                btn.innerHTML = '<span class="spinner-border spinner-border-sm me-1"></span> Copying...';
                btn.disabled = true;
                
                // 检查是否是SVG图片
                const isSVG = previewImg.src.includes('action=image') || previewImg.src.endsWith('.svg');
                
                if (isSVG) {
                    // SVG需要转换为PNG
                    const canvas = document.createElement('canvas');
                    const ctx = canvas.getContext('2d');
                    
                    // 创建Image对象加载SVG
                    const img = new Image();
                    img.crossOrigin = 'anonymous';
                    
                    await new Promise((resolve, reject) => {
                        img.onload = () => {
                            // 设置canvas尺寸
                            canvas.width = img.naturalWidth || img.width || 1200;
                            canvas.height = img.naturalHeight || img.height || 800;
                            
                            // 绘制SVG到canvas
                            ctx.fillStyle = '#F1F5F9';
                            ctx.fillRect(0, 0, canvas.width, canvas.height);
                            ctx.drawImage(img, 0, 0);
                            resolve();
                        };
                        img.onerror = reject;
                        img.src = previewImg.src;
                    });
                    
                    // 转换为PNG blob
                    const blob = await new Promise(resolve => canvas.toBlob(resolve, 'image/png'));
                    
                    // 复制到剪贴板
                    await navigator.clipboard.write([
                        new ClipboardItem({
                            'image/png': blob
                        })
                    ]);
                } else {
                    // 非SVG图片直接复制
                    const response = await fetch(previewImg.src);
                    const blob = await response.blob();
                    
                    await navigator.clipboard.write([
                        new ClipboardItem({
                            [blob.type]: blob
                        })
                    ]);
                }
                
                btn.innerHTML = '<i class="bi bi-check2"></i> Copied!';
                setTimeout(() => {
                    btn.innerHTML = origHtml;
                    btn.disabled = false;
                }, 2000);
            } catch (error) {
                console.error('Failed to copy image:', error);
                alert('Failed to copy image: ' + error.message);
                btn.innerHTML = origHtml;
                btn.disabled = false;
            }
        });

        // Download Image
        document.getElementById('downloadImageBtn').addEventListener('click', () => {
            const previewImg = document.getElementById('previewImg');
            if (!previewImg.src) {
                alert('No image to download');
                return;
            }
            
            // Download the image
            const a = document.createElement('a');
            a.href = previewImg.src;
            a.download = 'benchmark-report.png';
            a.click();
        });

        // Close Image Preview
        document.getElementById('closeImageBtn').addEventListener('click', () => {
            document.getElementById('imagePreview').classList.add('d-none');
        });

        // Download
        document.getElementById('downloadBtn').addEventListener('click', () => {
            const blob = new Blob([fileContent], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'benchmark-results.txt';
            a.click();
            URL.revokeObjectURL(url);
        });

        // Copy text
        function copyText(text) {
            const el = document.getElementById('copyTarget');
            el.value = text;
            el.select();
            document.execCommand('copy');
        }

        // Escape HTML
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Load image (已禁用)
        function loadImage() {
            return; // 禁用图片加载
            /*
            if (!filePath) return;
            
            // Extract year, month, and filename from filePath
            const parts = filePath.split('/');
            if (parts.length < 3) return;
            
            const year = parts[0];
            const month = parts[1];
            const fileName = parts[2];
            const imgUrl = `image.php?file=${encodeURIComponent(fileName)}&year=${year}&month=${month}`;
            
            const img = document.getElementById('previewImg');
            img.onload = () => document.getElementById('imagePreview').classList.remove('d-none');
            img.onerror = () => {}; // Silently fail if image doesn't exist
            img.src = imgUrl;
            */
        }

        // Show error
        function showError(msg) {
            document.getElementById('loading').classList.add('d-none');
            document.getElementById('error').classList.remove('d-none');
            document.getElementById('errorMsg').textContent = msg;
        }

        // Hide loading
        function hideLoading() {
            document.getElementById('loading').classList.add('d-none');
        }

        // Initialize
        loadFile();
    </script>
</body>
</html>